<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Module - Network</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
</head>
<body>
<div id="top"><!-- do not remove this div! -->
<!-- Disable default Doxygen header
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Stratagus
   &#160;<span id="projectnumber">3.3.2</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
-->
<!-- Begin of Stratagus header -->
<pre width="80">
         _________ __                 __
        /   _____//  |_____________ _/  |______     ____  __ __  ______
        \_____  \\   __\_  __ \__  \\   __\__  \   / ___\|  |  \/  ___/
        /        \|  |  |  | \// __ \|  |  / __ \_/ /_/  >  |  /\___ \
       /_______  /|__|  |__|  (____  /__| (____  /\___  /|____//____  >
               \/                  \/          \//_____/            \/
    ______________________                           ______________________
                          T H E   W A R   B E G I N S
                   Stratagus - A free fantasy real time strategy game engine
</pre>
<hr />
<!-- End of Stratagus header -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Module - Network </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="Basics"></a>
How does it work.</h1>
<p>Stratagus uses an UDP peer to peer protocol (p2p). The default port is 6660.</p>
<h2><a class="anchor" id="udp_vs_tcp"></a>
UDP vs. TCP</h2>
<p>UDP is a connectionless protocol. This means it does not perform retransmission of data and therefore provides very few error recovery services. UDP instead offers a direct way to send and receive datagrams (packets) over the network; it is used primarily for broadcasting messages.</p>
<p>TCP, on the other hand, provides a connection-based, reliable data stream. TCP guarantees delivery of data and also guarantees that packets will be delivered in the same order in which they were sent.</p>
<p>TCP is a simple and effective way of transmitting data. For making sure that a client and server can talk to each other it is very good. However, it carries with it a lot of overhead and extra network lag.</p>
<p>UDP needs less overhead and has a smaller lag. Which is very important for real time games. The disadvantages includes:</p>
<ul>
<li>You won't have an individual socket for each client. </li>
<li>Given that clients don't need to open a unique socket in order to transmit data there is the very real possibility that a client who is not logged into the game will start sending all kinds of garbage to your server in some kind of attack. It becomes much more difficult to stop them at this point. </li>
<li>Likewise, you won't have a clear disconnect/leave game message unless you write one yourself. </li>
<li>Some data may not reach the other machine, so you may have to send important stuff many times. </li>
<li>Some data may arrive in the wrong order. Imagine that you get package 3 before package 1. Even a package can come duplicate. </li>
<li>UDP is connectionless and therefore has problems with firewalls.</li>
</ul>
<p>I have chosen UDP. Additional support for the TCP protocol is welcome.</p>
<h2><a class="anchor" id="sc_vs_p2p"></a>
server/client vs. peer to peer</h2>
<ul>
<li>server to client</li>
</ul>
<p>The player input is send to the server. The server collects the input of all players and than send the commands to all clients.</p>
<ul>
<li>peer to peer (p2p)</li>
</ul>
<p>The player input is direct send to all others clients in game.</p>
<p>p2p has the advantage of a smaller lag, but needs a higher bandwidth by the clients.</p>
<p>p2p has been chosen for in-game. s/c for the preparing room.</p>
<h2><a class="anchor" id="bandwidth"></a>
bandwidth</h2>
<p>I wanted to support up to 8 players with 28.8kbit modems.</p>
<p>Most modems have a bandwidth of 28.8K bits/second (both directions) to 56K bits/second (33.6K uplink) It takes actually 10 bits to send 1 byte. This makes calculating how many bytes you are sending easy however, as you just need to divide 28800 bits/second by 10 and end up with 2880 bytes per second.</p>
<p>We want to send many packets, more updated per second and big packets, less protocol overhead.</p>
<p>If we do an update 6 times per second, leaving approximately 480 bytes per update in an ideal environment.</p>
<p>For the TCP/IP protocol we need following: IP Header 20 bytes UDP Header 8 bytes</p>
<p>With ~9 bytes per command and up to N(=9) commands there are 20+8+1+9*N(=120) bytes per packet. Sending it to 7 other players, gives 840 bytes per update. This means we could do 6 updates (each 166ms) per second (6*840=5040 bytes/s).</p>
<h2><a class="anchor" id="a_packet"></a>
Network packet</h2>
<ul>
<li>[IP Header - 20 bytes] </li>
<li>[UDP Header - 8 bytes] </li>
<li>[Header Data:Type - 1 byte] if Type is one of the InitConfigMessage </li>
<li>[Header Data:SubType - 1 byte] </li>
<li>[Data - depend of subtype (may be 0 byte)] else </li>
<li>[Header Data:Types - N-1 bytes] (for N commands) </li>
<li>[Header Data:Cycle - 1 byte] </li>
<li>[Data:Commands - Sum of Xi bytes for the N Commands]</li>
</ul>
<h2><a class="anchor" id="internals"></a>
Putting it together</h2>
<p>All computers in play must run absolute syncron. Only user commands are send over the network to the other computers. To reduce network traffic, commands are sent/executed every gameCyclesPerUpdate gameCycles. The command needs some time to reach the other clients (lag), so the command is not executed immediately on the local computer, but a delay (NetworkLag NetUpdates) later. Commands are stored in a circular array indexed by update time. Once each other players commands are received for a specified gameNetCycle, all commands of this gameNetCycle Each gameNetCycle, a package must be send. if there is no user command, a "dummy" sync package is send (which checks that all players are still in sync). If there are missing packages, the game is paused and old commands are resend to all clients.</p>
<h1><a class="anchor" id="missing"></a>
What features are missing</h1>
<ul>
<li>The recover from lost packets can be improved, as the player knows which packets is missing.</li>
</ul>
<ul>
<li>The UDP protocol isn't good for firewalls, we need also support for the TCP protocol.</li>
</ul>
<ul>
<li>Add a server/client protocol, which allows more players per game.</li>
</ul>
<ul>
<li>Lag (latency) and bandwidth should be automatic detected during game setup and later during game automatic adapted.</li>
</ul>
<ul>
<li>Also it would be nice, if we support viewing clients. This means other people can view the game in progress.</li>
</ul>
<ul>
<li>The current protocol only uses single cast, for local LAN we should also support broadcast and multicast.</li>
</ul>
<ul>
<li>Proxy and relays should be supported, to improve the playable over the internet.</li>
</ul>
<ul>
<li>We can sort the command by importants, currently all commands are send in order, only chat messages are send if there are free slots.</li>
</ul>
<ul>
<li>password protection the login process (optional), to prevent that the wrong player join an open network game.</li>
</ul>
<ul>
<li>add meta server support, I have planned to use bnetd and its protocol.</li>
</ul>
<h1><a class="anchor" id="api"></a>
API How should it be used.</h1>
<p><a class="el" href="network_8cpp.html#ad5d19b49bf082f99e833f1619fa937c1">InitNetwork1()</a> <a class="el" href="structOpen.html">Open</a> port. Must be called by Lua</p>
<p><a class="el" href="network_8cpp.html#a9d3ab8c36c690f0ed56f1ec42816255d" title="Initialise network.">ExitNetwork1()</a> Close port. Called internally and by Lua</p>
<p>::NetworkOnGameStart() Initialize msg stuff for ingame communication.</p>
<p><a class="el" href="network_8cpp.html#aed4da7550e85618912b9f43f59994d45" title="Initialise network data for ingame communication.">NetworkEvent()</a> Manage network event (preparation room + ingame).</p>
<p><a class="el" href="network_8cpp.html#a9419bda4a9887da6edd137aa86cdd7d1" title="Quit game: warn other users.">NetworkRecover()</a> Do stuff to have again NetworkInSync == true</p>
<p><a class="el" href="network_8cpp.html#abff2ea5452021ce87032c53955a54510" title="Recover network.">NetworkCommands()</a> Network Updates : exec current command, and send commands to other players</p>
<p><a class="el" href="network_8cpp.html#a4b1d83fcec21423e903cef57d9c638e8" title="Network is in sync.">NetworkFildes</a> UDP Socket for communication.</p>
<p><a class="el" href="network_8cpp.html#af78757e14fe4d29ec3fa3ce0433d165a" title="Network file descriptor.">NetworkInSync</a> false when commands of the next gameNetCycle of the other player are not ready.</p>
<p><a class="el" href="network_8cpp.html#a61656c86317745b47e41d0aee6918907" title="Send network command.">NetworkSendCommand()</a> Send a normal unit order.</p>
<p><a class="el" href="network_8cpp.html#a58727f23bfc41c14922270a3cebcc037" title="Send extended network command.">NetworkSendExtendedCommand()</a> Send special command (diplomacy, ...)</p>
<p><a class="el" href="network_8cpp.html#ab09eca7ac063101fbb812982d4c7c203" title="Get all network commands.">NetworkSendChatMessage()</a> Send a chat message to others player</p>
<p><a class="el" href="network_8cpp.html#a691be9bb929e5d0d7c8fc73123d20782" title="Hold in sync.">NetworkQuitGame()</a> Warn other users that we leave. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->

<hr class="footer"/><address class="footer"><small>
Generated on Wed Aug 10 2022 20:03:32 for Stratagus by&#160;<a href="http://www.doxygen.org/index.html"><img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17</small></address>
<!-- Begin of Stratagus footer -->
(C) Copyright 1998-2012 by The <a href="https://launchpad.net/stratagus">Stratagus</a> Project under the <a href="../gpl.html">GNU General Public License</a>.<br/>
All trademarks and copyrights on this page are owned by their respective owners.<br/>
<!-- End of Stratagus footer -->
</body>
</html>
